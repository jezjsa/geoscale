# GeoScale: Local SEO Parent-Child Page Structure

## Overview

GeoScale needs to support SEO-friendly local landing page hierarchies with automatic internal linking.

### Page Hierarchy (3 Tiers)

| Level | Example | Source |
|-------|---------|--------|
| **Main Service Page** | `/web-design` | Already exists on WordPress (user provides URL) |
| **Main Town Page** | `/web-design-doncaster` | Generated by GeoScale, `parent_location_id = null` |
| **Suburb Page** | `/web-design-eden-thorpe` | Generated by GeoScale, `parent_location_id = [town id]` |

---

## Implementation Tasks

### 1. Database Changes

#### 1.1 Add `service_page_url` to `project_services` table

```sql
ALTER TABLE project_services 
ADD COLUMN service_page_url TEXT NULL;

COMMENT ON COLUMN project_services.service_page_url IS 'URL to the existing main service page on WordPress (e.g., https://example.com/web-design)';
```

#### 1.2 Add `parent_location_id` to `location_keywords` table

```sql
ALTER TABLE location_keywords 
ADD COLUMN parent_location_id UUID NULL REFERENCES location_keywords(id) ON DELETE SET NULL;

COMMENT ON COLUMN location_keywords.parent_location_id IS 'Parent town page ID for suburb pages. NULL = main town page.';

CREATE INDEX idx_location_keywords_parent ON location_keywords(parent_location_id);
```

---

### 2. UI Changes

#### 2.1 Add Service Modal (`AddServiceModal.tsx`)

Add a new field below "Description (optional)":

- **Label:** "Main Service Page URL" (optional)
- **Placeholder:** Pre-populate with `{project.wp_url}/service-slug` 
- **Helper text:** "Link to your existing service page on WordPress"
- **Field name:** `service_page_url`

The `wp_url` is available from the `projects` table for pre-population.

#### 2.2 Add Location Modal / Combinations Table

When adding a new location-keyword combination:

1. Add a toggle: `[ ] Is this a suburb of an existing town?`
2. If toggled ON:
   - Show dropdown of existing **main town pages** for the same service (where `parent_location_id IS NULL`)
   - Store selected parent's `location_keywords.id` as `parent_location_id`
3. Allow editing/removing the suburb relationship

---

### 3. Content Generation Changes (`generate-content/index.ts`)

#### 3.1 Fetch Additional Data

When generating content, fetch:

```typescript
// Get service page URL
const { data: service } = await supabase
  .from("project_services")
  .select("service_page_url")
  .eq("id", lkData.service_id)
  .single();

// Get parent town page (if this is a suburb)
let parentTownData = null;
if (lkData.parent_location_id) {
  const { data } = await supabase
    .from("location_keywords")
    .select("phrase, wp_page_url, location:project_locations!location_keywords_location_id_fkey(name)")
    .eq("id", lkData.parent_location_id)
    .single();
  parentTownData = data;
}

// Get suburb pages (if this is a main town)
const { data: suburbPages } = await supabase
  .from("location_keywords")
  .select("phrase, wp_page_url, location:project_locations!location_keywords_location_id_fkey(name)")
  .eq("parent_location_id", locationKeywordId)
  .eq("status", "pushed"); // Only include published suburbs
```

#### 3.2 Update Prompt Variables

Pass to the prompt:

| Variable | Description | Used For |
|----------|-------------|----------|
| `main_service_url` | From `project_services.service_page_url` | All pages |
| `parent_town_name` | Parent location name | Suburb pages |
| `parent_town_url` | Parent's `wp_page_url` | Suburb pages |
| `suburb_list` | Array of `{name, url}` | Main town pages |

#### 3.3 Update OpenAI Prompt

Add new sections to the prompt based on page type:

**For Suburb Pages (has `parent_location_id`):**
```
Parent Town Link: ${parentTownName} - ${parentTownUrl}
Main Service Link: ${mainServiceUrl}

Additional Instructions for Suburb Pages:
- In the intro or summary section, include a natural link to the parent town page.
  Example: "For wider coverage across the area, see our main <a href="${parentTownUrl}">${serviceName} in ${parentTownName}</a> page."
- Include a link to the main service page in the CTA section.
  Example: "Learn more about all our <a href="${mainServiceUrl}">${serviceName} services</a>."
```

**For Main Town Pages (no `parent_location_id`, has suburbs):**
```
Main Service Link: ${mainServiceUrl}
Suburb Pages We Cover:
${suburbList.map(s => `- ${s.name}: ${s.url}`).join('\n')}

Additional Instructions for Main Town Pages:
- Include a link to the main service page in the CTA section.
- Add a section titled "Areas We Also Cover" or "Nearby Areas We Serve" listing all suburb pages with links.
  Format as a bulleted list with each suburb name linking to its page URL.
```

**For All Pages (if main service URL exists):**
```
Main Service Link: ${mainServiceUrl}

- Include a link to the main service page where appropriate (e.g., in the CTA or summary).
```

---

### 4. Automatic Linking Summary

| Page Type | Links To |
|-----------|----------|
| **Suburb Page** | Parent town page + Main service page |
| **Main Town Page** | Main service page + All suburb pages |
| **Main Service Page** | (External - managed by user on WordPress) |

---

### 5. Files Modified

| File | Changes | Status |
|------|---------|--------|
| `supabase/migrations/` | Added `service_page_url` to `project_services`, `parent_location_id` to `location_keywords` | ✅ Done |
| `src/components/projects/AddServiceDialog.tsx` | Added `service_page_url` field with auto-populate from wp_url | ✅ Done |
| `src/api/services.ts` | Updated interface and CRUD functions for `service_page_url` | ✅ Done |
| `src/pages/ProjectDetailPage.tsx` | Pass `wpUrl` prop to AddServiceDialog | ✅ Done |
| `supabase/functions/generate-content/index.ts` | Fetch parent/suburb data, add linking instructions to prompt | ✅ Done |
| `src/components/projects/AddLocationsDialog.tsx` | Add suburb toggle + parent dropdown | ✅ Done |
| `src/api/combinations.ts` | Update to handle `parent_location_id` | ✅ Done |

---

### 6. Future Enhancements (Not in Scope)

- Breadcrumb generation (optional toggle)
- Automatic regeneration of parent pages when new suburbs are added
- Visual hierarchy display in the combinations table